---
title: "Appendix"
output:
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "../figures/", fig.width = 5, fig.height = 5)
```

```{r read_chunks, cache=FALSE, echo=FALSE}
knitr::read_chunk("../scripts/99_utils.R")
```

```{r source_utils, message=FALSE, results='hide', echo=FALSE, warning=FALSE}
# setwd("scripts")
# source("99_utils.R")
```

```{r load_data, message=FALSE, results='hide', echo=FALSE, warning=FALSE}
  if(file.exists("../scripts/01.5_loaddata.R")){
    source("../scripts/01.5_loaddata.R")  
  }else{
    source("scripts/01.5_loaddata.R")  
  }
```

```{r recursive_partitioning_viz, echo=FALSE, eval=FALSE}
plot_tree(gettree(readRDS("../data/maxdepth_forest.rds")), 
          title = "Max Depth")

plot_tree(gettree(readRDS("../data/iws/cd_forest.rds")), 
          title = "Distance to Closest \n Upstream Lake (standardized)")
# inv_inv_closest(-1.51, nes_rf_iws) # 3773.614
plot_tree(gettree(readRDS("../data/nws/cd_forest.rds")), 
          title = "Distance to Closest \n Upstream Lake (standardized)")
# inv_inv_closest(-1.469, nes_rf_nws) # 2681.288

plot_tree(gettree(readRDS("../data/iws/sr_forest.rds")), 
          title = "Stream Order Ratio")
plot_tree(gettree(readRDS("../data/nws/sr_forest.rds")), 
          title = "Stream Order Ratio")

plot_tree(gettree(readRDS("../data/iws/linklength_forest.rds")), 
          title = "Link Length")
plot_tree(gettree(readRDS("../data/nws/linklength_forest.rds")), 
          title = "Link Length")

plot_tree(gettree(readRDS("../data/iws/uplakearea_forest.rds")), 
          title = "Upstream Lake Area")
# plot_tree(gettree(readRDS("01_Chapter/data/nws/uplakearea_forest.rds")), 
#           title = "Upstream Lake Area")

plot_tree(gettree(readRDS("../data/iws/baseflow_forest.rds")), 
          title = "Baseflow")

plot_tree(gettree(readRDS("../data/iws/wetland-cover_forest.rds")), 
          title = "Wetland Cover")

plot_tree(gettree(readRDS("../data/iws/streamdensity_forest.rds")), 
          title = "Stream Density")
```

```{r graphical_exploratory_analysis, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8.4, fig.cap="Exploratory plots", eval=FALSE}
partition_splits <- read.csv("../figures/table_1.csv", stringsAsFactors = FALSE)

nes_iws$p_pnt_source <-  rowSums(cbind(nes_iws$p_pnt_source_muni,
                                       nes_iws$p_pnt_source_septic,
                                       nes_iws$p_pnt_source_industrial),
                                 na.rm = TRUE)

md_v_la <- ggplot(data = nes_iws) + 
  geom_point(aes(x = maxdepth, 
                 y = upstream_lakes_4ha_area_ha, color = lakeconnection)) +
  ylab("Upstream Lake Area (ha)") + xlab("Max Depth (m)") + 
  geom_vline(data = partition_splits, aes(
    xintercept = partition_splits$splits[
      partition_splits$pnames2 == "md" & partition_splits$scale == "focal"])) + 
  geom_hline(data = partition_splits, aes(
    yintercept = partition_splits$splits[
      partition_splits$pnames2 == "la" & partition_splits$scale == "nws"])) + 
  scale_y_log10()

md_v_ll_iws <- ggplot(data = nes_iws) + 
  geom_point(aes(x = maxdepth, 
                 y = link_length, color = lakeconnection)) +
  ylab("Link Length") + xlab("Max Depth (m)") + 
  geom_vline(data = partition_splits, aes(
    xintercept = partition_splits$splits[
      partition_splits$pnames2 == "md"])) + 
  geom_hline(data = partition_splits, aes(
    yintercept = partition_splits$splits[
      partition_splits$pnames2 == "ll" & partition_splits$scale == "iws"]))

md_v_ll_nws <- ggplot(data = nes_nws) + 
  geom_point(aes(x = maxdepth, 
                 y = avg_link_length, color = lakeconnection)) +
  ylab("Link Length") + xlab("Max Depth (m)") + 
  geom_vline(data = partition_splits, aes(
    xintercept = partition_splits$splits[
      partition_splits$pnames2 == "md"])) + 
  geom_hline(data = partition_splits, aes(
    yintercept = partition_splits$splits[
      partition_splits$pnames2 == "ll" & partition_splits$scale == "nws"]))

md_v_cd_nws <- ggplot(data = nes_nws) + 
  geom_point(aes(x = maxdepth, 
                 y = closest_lake_distance, color = lakeconnection)) +
  ylab("Closest Lake Distance") + xlab("Max Depth (m)") + 
  geom_vline(data = partition_splits, aes(
    xintercept = partition_splits$splits[
      partition_splits$pnames2 == "md"])) + 
  geom_hline(data = partition_splits, aes(
    yintercept = partition_splits$splits[
      partition_splits$pnames2 == "cd" & partition_splits$scale == "nws"]))

ll_v_cd_nws <- ggplot(data = nes_nws) + 
  geom_point(aes(x = avg_link_length, 
                 y = closest_lake_distance, color = lakeconnection)) +
  ylab("Closest Lake Distance") + xlab("Link Length") + 
  geom_vline(data = partition_splits, aes(
    xintercept = partition_splits$splits[
      partition_splits$pnames2 == "ll" & partition_splits$scale == "nws"])) + 
  geom_hline(data = partition_splits, aes(
    yintercept = partition_splits$splits[
      partition_splits$pnames2 == "cd" & partition_splits$scale == "nws"])) + 
  scale_x_log10() + scale_y_log10() + xlab("log(Link Length)") + ylab("log(cd)")

legend <- get_legend(md_v_la)

plot_grid(md_v_la + theme(legend.position = "none"), 
          md_v_ll_iws + theme(legend.position = "none"), 
          md_v_ll_nws + theme(legend.position = "none"),
          ll_v_cd_nws + theme(legend.position = "none"),
          ggplot() + geom_point(aes(nes_iws$hu12_baseflowindex_mean, nes_nws$baseflow, color = nes_iws$state %in% c("MAINE", "NEW HAMPSHIRE", "IOWA", "MISSOURI", "OHIO", "ILLINOIS"))) + 
            geom_hline(aes(yintercept = 53.43)) +
            geom_vline(aes(xintercept = 63.76)) + 
            ylab("NWS Baseflow") + xlab("IWS Baseflow") + 
            theme(legend.position = "none"),
          ggplot() + geom_point(aes(
            nes_iws$iws_streamdensity_streams_density_mperha, 
            nes_nws$stream_density, color = nes_iws$lakeconnection)) + 
            geom_hline(aes(yintercept = 10.4), color = "red") +
            geom_vline(aes(xintercept = 4.43), color = "red") +
            geom_abline(aes(slope = 1, intercept = 0)) + 
            ylab("NWS Stream Density") + xlab("IWS Stream Density") + 
            theme(legend.position = "none"),
          
          ggplot() + geom_point(aes(nes_iws$closest_lake_distance, 
                                    nes_nws$closest_lake_distance, 
                                    color = nes_iws$lakeconnection)) + 
            geom_hline(aes(yintercept = 2776.81), color = "red") +
            geom_vline(aes(xintercept = 3773.61), color = "red") +
            geom_abline(aes(slope = 1, intercept = 0)) +
            scale_x_log10() + 
            scale_y_log10() + 
            ylab("NWS Lake Distance") + xlab("IWS Lake Distance") + 
            theme(legend.position = "none"),
          ggplot(data = nes_iws) + 
            geom_point(aes(x = p_pnt_source / (p_nonpnt_source + p_pnt_source), 
                           y = p_percent_retention)) + 
            xlab("p_percent_pnt-source"), 
          ncol = 2)
```

```{r graphical_exploratory_analysis_cont, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6.3, fig.cap="Exploratory plots cont", eval=FALSE}
lg <- lagosne_load("1.087.1")
nes_nws_temp <- dplyr::left_join(nes_nws, select(lg$iws, lagoslakeid, iws_ha))
nes_nws_temp$p_pnt_source <-  rowSums(cbind(nes_nws_temp$p_pnt_source_muni,
                                       nes_nws_temp$p_pnt_source_septic,
                                       nes_nws_temp$p_pnt_source_industrial),
                                 na.rm = TRUE)
nes_nws_sf    <- coordinatize(nes_nws_temp, "lat", "long")
us_states <- st_intersects(us_states(), nes_nws_sf)
us_states <- us_states()[unlist(lapply(us_states, function(x) length(x) > 0)),]

plot_grid(
ggplot() + geom_point(data = nes_nws_temp, 
                      aes(x = iws_ha, y = avg_link_length)) + 
  xlim(300, 100000) + ylab("Average Link Length") + 
  xlab("Interlake Watershed Area (ha)") + 
  geom_hline(aes(yintercept = 2380.09), color = "red"),

ggplot() + geom_point(data = nes_nws_temp, 
                      aes(x = iws_ha, y = closest_lake_distance)) + 
  xlim(300, 100000) + ylab("Closest Lake Distance") + 
  xlab("Interlake Watershed Area (ha)") + 
  geom_hline(aes(yintercept = 3273.65), color = "red"), 

ggplot() + geom_point(data = nes_nws_temp, 
                      aes(x = iws_ha, y = p_percent_retention)) + 
  xlim(300, 100000) + ylab("P Retention") + 
  xlab("Interlake Watershed Area (ha)"),

ggplot() + geom_sf(data = us_states) + 
  geom_sf(data = nes_nws_sf, aes(color = p_pnt_source / (p_nonpnt_source + p_pnt_source))) + theme(legend.direction = "horizontal", legend.position = "bottom") + ggtitle("% pnt source P"),

ggplot() + geom_sf(data = us_states) + 
  geom_sf(data = nes_nws_sf, aes(color = log(maxdepth))) + theme(legend.direction = "horizontal", legend.position = "bottom") + ggtitle("max depth"), 
ggplot() + geom_sf(data = us_states) + 
  geom_sf(data = nes_nws_sf, aes(color = log(iws_ha))) + theme(legend.direction = "horizontal", legend.position = "bottom") + ggtitle("iws area"), 
ncol = 2)
```

```{r graphical_exploratory_analysis_cont_cont, echo=FALSE, message=FALSE, warning=FALSE, fig.height=5.3, fig.cap="Exploratory plots cont x 2", eval=FALSE}
lg <- lagosne_load("1.087.1")

nes_nws_temp <- nes_nws
nes_nws_temp$p_pnt_source <-  rowSums(cbind(nes_nws_temp$p_pnt_source_muni,
                                            nes_nws_temp$p_pnt_source_septic,
                                            nes_nws_temp$p_pnt_source_industrial),
                                      na.rm = TRUE)
nes_nws_sf    <- coordinatize(nes_nws_temp, "lat", "long")
us_states <- st_intersects(us_states(), nes_nws_sf)
us_states <- us_states()[unlist(lapply(us_states, function(x) length(x) > 0)),]

plot_grid(
  ggplot() + geom_point(data = nes_nws_temp, 
                        aes(x = nws_ha, y = upstream_lakes_4ha_area_ha)) + 
    xlim(300, 100000) + ylab("Up. Lk. Area") + 
    xlab("Network Watershed Area (ha)"),
  ggplot() + geom_point(data = nes_nws_temp, 
                        aes(x = nws_ha, y = stream_order_ratio)) + 
    xlim(300, 100000) + ylab("Stream Order Ratio") + 
    xlab("Network Watershed Area (ha)"), 
  
  ggplot() + geom_point(data = nes_nws_temp, 
                        aes(x = nws_ha, y = p_percent_retention)) + 
    xlim(300, 100000) + ylab("P Retention") + 
    xlab("Network Watershed Area (ha)"),
  
  ggplot() + geom_point(data = nes_nws_temp, 
                        aes(x = nws_ha, 
                            y = p_pnt_source / (p_nonpnt_source + p_pnt_source))) + 
    xlim(300, 100000) + ylab("% Pnt Source") + 
    xlab("Network Watershed Area (ha)"), 
  ncol = 2)
```

```{r stream_density-vs-link_length, eval=FALSE}
test <- dplyr::select(nes_nws, 
              avg_link_length, 
              stream_density, 
              closest_lake_distance) %>%
dplyr::rename("Average Link Length" = avg_link_length,
              "Stream Density" = stream_density,
              "Closest Lake Distance" = closest_lake_distance) %>%
dplyr::mutate(`Closest Lake Distance` = `Closest Lake Distance` / 100, 
              `Average Link Length` = `Average Link Length` / 100)

pair_opts <- theme(axis.text = element_blank(), 
      axis.ticks = element_blank())

cowplot::plot_grid(
  ggplot(data = test) + 
    geom_point(aes(y = `Average Link Length`, x = `Stream Density`)) + 
    pair_opts,
  ggplot(data = test) + 
    geom_point(aes(y = `Average Link Length`, x = `Closest Lake Distance`)) + 
    ylab("") + pair_opts, 
  ggplot(data = test) + 
    geom_point(aes(y = `Closest Lake Distance`, x = `Stream Density`)) +
    pair_opts,
  ggplot() + geom_blank(),
  nrow = 2, ncol = 2)
```

```{r conceptual_summary, echo=FALSE, fig.cap="Connectivity metric effects on lake processing.", eval=FALSE}
dt <- data.frame(
  rbind(
    c("closest lake distance", "lower", "higher", "lower", "higher", "lake-stream", "long"), 
    c("average link length", "lower", "higher", "lower", "higher", "stream", "long"), 
    c("lakeconnection", "DR_Stream", "higher", "lower", "higher", "lake", "long"), 
    c("upstream lake area", "lower", "higher", "lower", "higher", "lake", "lat"), 
    c("stream density", "higher", "higher", "lower", "higher", "stream", "lat"),
    c("baseflow", "higher", "higher", "lower", "higher", "stream", "lat"), 
    c("stream order ratio", "higher", "higher", "lower", "higher", "stream", "long")))

names(dt) <- c("metric", "direction", "k", "connectivity", "in_lake_processing", "axis", "connectivity type")

knitr::kable(dt)
```

```{r read_metric_chunks, cache=FALSE, echo=FALSE}
knitr::read_chunk("../data/connectivity_metrics.R")
```

```{r load_packages, echo=FALSE}

```

```{r source_functions, echo=FALSE, warning=FALSE, message=FALSE}

```

```{r iws_vs_nws-gis, cache=TRUE, echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# lagoslakeid <- 6302
# iws <- pull_iws(lagoslakeid, maxsteps = Inf)
# nws <- pull_nws(lagoslakeid, maxsteps = Inf)
# nws_lakes <- pull_lakes(nws)
# saveRDS(iws, "../data/iws_extent.rds")
# saveRDS(nws, "../data/nws_extent.rds")
# saveRDS(nws_lakes, "../data/nws_lakes.rds")

iws <- readRDS("../data/iws_extent.rds")
nws <- readRDS("../data/nws_extent.rds")
nws_lakes <- readRDS("../data/nws_lakes.rds")

nws_lakes <- nws_lakes[order(st_area(nws_lakes), decreasing = TRUE),]
nws_lakes <- nws_lakes[1:2,]

iws_outline <- concaveman(st_cast(iws, "POINT"))
nws_outline <- concaveman(st_cast(nws, "POINT"))
lake_1_outline <- concaveman(st_cast(nws_lakes[1,], "POINT"))
lake_2_outline <- concaveman(st_cast(nws_lakes[2,], "POINT"))

ggplot() + 
  geom_sf(data = nws_outline, color = "yellow", size = 2) + 
  geom_sf(data = iws_outline, color = "cyan", size = 2) + 
  geom_sf(data = nws) +
  geom_sf(data = lake_1_outline, color = "cyan") +
  geom_sf(data = lake_2_outline, color = "yellow") +
  coord_sf(crs = st_crs(nws), datum = NA) + 
  # geom_sf(data = iws) + 
  theme_void()

```

```{r best_partition_maps, cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
library(tmap)
library(sf)
library(LAGOSNE)
library(USAboundaries)
library(dplyr)

results_table <- read.csv("../scripts/table_1.csv", stringsAsFactors = FALSE)
ll_split <- dplyr::filter(results_table, 
                          nws_names == "avg_link_length" & 
                          scale == "nws")$splits

nes_nws <- mutate(nes_nws, grp = ifelse(avg_link_length > ll_split, 
                                  "High", "Low"))

nes_sf    <- coordinatize(nes_nws, "lat", "long")
us_states <- st_intersects(us_states(), nes_sf)
us_states <- us_states()[unlist(lapply(us_states, function(x) length(x) > 0)),]

us <- USAboundaries::us_boundaries()
us <- us[unlist(lapply(st_intersects(us, nes_sf), function(x) length(x) > 0)),]
us <- filter(us, stusps != "AR")

nes_extent <- group_by(us, jurisdiction_type)
nes_extent <- st_union(nes_extent)
nes_extent <- as_Spatial(nes_extent)

palette <- c("black",
              "black")

m_nes <-  tm_shape(us) + tm_polygons() +
          tm_shape(nes_extent) + tm_borders(lwd = 3) +
          tm_shape(dplyr::filter(nes_sf, !is.na(grp))) + tm_dots("grp", palette = palette,
                                 size = 0.2, legend.show = FALSE, 
                                 title = "Average Link Length") +
          # tm_credits("National Eutrophication Survey") +
          tm_layout(frame = FALSE,
                    legend.outside = FALSE,
                    legend.stack = "horizontal")

save_tmap(m_nes, "../figures/best_partition_maps-1.png",
          scale = 0.7, width = 3.125)

# # # # #

palette <- c(viridis::viridis(1, begin = 0),
             viridis::viridis(1, begin = 0.5))


m_nes <- tm_shape(us) + tm_polygons() +
          tm_shape(nes_extent) + tm_borders(lwd = 3) +
          tm_shape(dplyr::filter(nes_sf, !is.na(grp))) + tm_dots("grp", palette = palette,
                                 size = 0.2, legend.show = TRUE, 
                                 title = "Average Link Length") +
          # tm_credits("National Eutrophication Survey") +
          tm_layout(frame = FALSE,
                    legend.outside = FALSE,
                    legend.stack = "horizontal")

save_tmap(m_nes, "../figures/best_partition_maps-2.png",
          scale = 0.7, width = 3.125)
```

```{r plot_tree_example, echo=FALSE, fig.width=2, fig.height=3, eval=FALSE, eval=FALSE}
plot_tree(gettree(readRDS("../data/nws/linklength_forest.rds")), 
          title = "Link Length")
```

```{r partition_example_scatter, fig.height=4, fig.width=4.2, warning=FALSE, eval=FALSE}
# setwd("manuscript")
results_table <- read.csv("../scripts/table_1.csv", stringsAsFactors = FALSE)
ll_split <- dplyr::filter(results_table, 
                          nws_names == "avg_link_length" & 
                          scale == "nws")$splits

nes_nws <- mutate(nes_nws, grp = ifelse(avg_link_length > ll_split, 
                                  "Higher", "Lower"))

ggplot(data = dplyr::filter(nes_nws, 
                     !is.na(avg_link_length))) + 
         geom_point(aes(x = avg_link_length, 
                                        y = p_percent_retention, 
                                        color = grp), 
                                    size = 1.3) + 
  scale_color_manual(values = c(viridis::viridis(1, begin = 0), 
                     viridis::viridis(1, begin = 0.5))) +
  ylab("P Retention") + xlab("Avg. Link Length") + 
  geom_vline(xintercept = ll_split) + 
  theme(legend.position = "none") 
```

```{r 05_partition_vollenweider, echo=FALSE, fig.cap="Residence time (yr) versus P retention for the NES dataset and hierarchical model fits to the data where the solid lines and shaded intervals represent the median and central 95% model  estimates respectively. The green lines and symbols are the estimates from the lower of the two partition groups while the purple lines are estimates for the upper of the two partition groups (see Table 2).", fig.width = 4.8, fig.height=5, warning=FALSE, eval=FALSE}

knitr::include_graphics("../figures/05_partition_vollenweider-1.pdf")
```

```{r milstead_reanalysis}
library(cowplot)
library(ggplot2)
library(sf)
library(nhdR)
library(LAGOSNE)
library(maps)
library(dplyr)

## load data ####
milstead_path <- "data/milstead_2013.csv"
# unlink(milstead_path)

if(!file.exists(milstead_path)){
  states <- sf::st_as_sf(map("state", plot = FALSE, fill = TRUE))
  nhd_plus <- nhdR::nhd_plus_load(c(1,2), dsn = "NHDWaterbody")
  nhd_plus <- st_transform(nhd_plus, st_crs(states))
  states <- states[which(sapply(
             sf::st_covers(states, nhd_plus),
             function(x) length(x)) > 0),]
 
  nhd <- nhdR::nhd_load(state.abb[tolower(state.name) %in% states$ID], "NHDWaterbody")
  nhd$GNIS_ID <- sapply(as.character(nhd$GNIS_ID), function(x) substring(x, 3, nchar(x)))
  nhd <- nhd[!is.na(nhd$ReachCode),]
  st_geometry(nhd) <- NULL
  lg <- lagosne_load("1.087.1")
  
  library(fulltext)
  query <- ft_search(query = "Estimating Summer Nutrient Concentrations in
                      Northeastern Lakes from SPARROW Load Predictions and Modeled
                      Lake Depth and Volume", from = "plos")
  doi <- ft_links(query)$plos$ids
  milstead <- read.csv(ft_get_si(doi, 1))

  # paused here
  milstead_j <- dplyr::left_join(milstead, 
                  dplyr::select(nhd_plus, COMID, REACHCODE), 
                by = c("WB_ID" = "COMID")) %>%
    dplyr::left_join(
        dplyr::select(nhd, Permanent_Identifier, ReachCode), 
      by = c("REACHCODE" = "ReachCode")) %>%
    dplyr::left_join(
        dplyr::select(lg$lakes.geo, lakeconnection, lakes_nhdid), 
      by = c("Permanent_Identifier" = "lakes_nhdid")) %>%
    dplyr::left_join(
        dplyr::select(lg$locus, nhdid, nhd_lat, nhd_long), 
      by = c("Permanent_Identifier" = "nhdid"))
  milstead_j <- milstead_j[complete.cases(milstead_j[,c("nhd_lat", "nhd_long")]),]
  milstead_j <- milstead_j[,nchar(names(milstead_j)) < 30] 
  milstead_j <- milstead_j[, -which(names(milstead_j) == "geometry")]

  write.csv(milstead_j, milstead_path, row.names = FALSE)
}

md    <- read.csv(milstead_path, stringsAsFactors = FALSE)
md$Rp <- 1 - (as.numeric(md$Poutput) / as.numeric(md$Pinput))
md    <- md[md$Rp >= 0 & md$Rp <= 1,]
md$hrt <- as.numeric(md$hrt)
md     <- md[md$hrt > 0,] 
md     <- md[md$Area > 0.04,] # rm less than 4 ha

# library(magrittr)
# glm.fit <- milstead %>% dplyr::group_by(lakeconnectivity) %>% dplyr::do(fit = glm(Rp ~ hrt, family = "binomial", data = .))
# 
# broom::tidy(glm.fit, fit)
# glm.stats <- as.data.frame(broom::glance(glm.fit, fit))
# # https://ww2.coastal.edu/kingw/statistics/R-tutorials/logistic.html
# 1 - pchisq(glm.stats$null.deviance - glm.stats$deviance, 1)

# ggplot(data = milstead[!is.na(milstead$lakeconnectivity),], aes(x = lakeconnectivity, y = hrt)) + geom_boxplot(notch = TRUE) + scale_y_log10()

yr_labels <- c("1e-07", "1e-05", 
               as.character(10/365), 
               as.character(2/12), as.character(6/12), 
               "2", "10")

format_labels <- function(x, mult_factor){
  gsub("\\.+$", "\\1", gsub("0+$", "\\1",
    trimws(format(round(as.numeric(x), 6) * 
      mult_factor, scientific = FALSE)), perl = TRUE))
  }

day_labels   <- ceiling(as.numeric(
  format_labels(yr_labels, 365)) / 10) * 10
minute_labels  <- ceiling(as.numeric(
  format_labels(yr_labels, 365 * 24 * 60)) / 10) * 10
month_labels  <- round(as.numeric(
  format_labels(yr_labels, 12)), 0)

mixed_labels <- paste0(
      c(minute_labels[1:2], day_labels[3], month_labels[4:5], yr_labels[6:7]), 
      c(" min", " min", " days", " months", " months", " years", " years"))

quants <- exp(quantile(log(md[, "hrt"]), na.rm = TRUE))

gg_fit_single <- 
  ggplot(data = md, 
    aes(x = hrt, y = Rp)) + geom_point(size = 0.9) +
  scale_x_log10(labels = mixed_labels, 
    breaks = as.numeric(yr_labels), limits = c(1 / 365, 11)) +
  stat_smooth(method = "glm", method.args = list(family = "binomial"), 
              se = TRUE) +
  scale_color_brewer(palette = "Set1") +
  cowplot::theme_cowplot() + 
  theme(legend.position = "none", legend.title = element_blank(), legend.text = element_text()) +
  xlab("Residence Time") +
  ylab("P Retention (%)") + 
  geom_segment(data = data.frame(x = quants[c(2, 4)], y = c(0.8, 0.8)), 
               aes(x = x, y = c(0, 0), xend = x, yend = y), 
               color = "gray42", size = 1.5, linetype = 2)

# if(!interactive()){
#   ggsave("milstead_single.pdf", gg_fit_single, height = 5)
# }

# milstead <- droplevels(milstead[milstead$lakeconnectivity != "Isolated",])
gg_fit_multi <- ggplot(data = md, aes(x = hrt, y = Rp)) +
  geom_point(size = 0.9) +
  scale_x_log10(labels = mixed_labels, 
                breaks = as.numeric(yr_labels), limits = c(1 / 365, 11)) +
  stat_smooth(method = "glm", method.args = list(family = "binomial"), 
              se = TRUE, aes(color = lakeconnection), 
              data = md) +
  scale_color_brewer(palette = "Set1") +
  cowplot::theme_cowplot() + 
  theme(legend.title = element_blank(), legend.position = c(0.13, 0.8),
        legend.text = element_text()) +
  xlab("Residence Time") +
  ylab("P Retention (%)") + 
  geom_segment(data = data.frame(x = quants[c(2, 4)], y = c(0.8, 0.8)), 
               aes(x = x, y = c(0, 0), xend = x, yend = y), 
               color = "gray42", size = 1.5, linetype = 2)

if(!interactive()){  
  gg_fit_multi
}

# legend <- get_legend(gg_fit_multi)
# gg <- plot_grid(gg_fit_single, gg_fit_multi, scale = c(1, 1), rel_widths = c(3, 3), nrow = 1)
# 
# if(!interactive()){
#   ggsave("milstead_conny.pdf", gg, height = 3.5, width = 7)
# }

# ggsave("milstead_conny_nogroup.pdf", gg)

# hist(log(x))
# hist(log(dt[dt$variable == "x_raw", "value"]))

# nes <- read.csv("/home/jose/R/scripts/NES/nes_data.csv")
# nes <- nes[!is.na(nes$retention_time),] 
# 
# nes$retention_time[nes$retention_time_units == "days" & 
#   !is.na(nes$retention_time_units)] <- 
#   nes$retention_time[nes$retention_time_units == "days" & 
#                        !is.na(nes$retention_time_units)] / 365
# 
# dt <- data.frame(variable = "Milstead", 
#           reshape2::melt(milstead[,"hrt"]))
# 
# # quants <- exp(quantile(log(dt$value)))
# # format_labels(quants, 365)
# # format_labels(quants, 12)
# 
# dt <- rbind(dt, 
#         data.frame(variable = "NES", 
#           reshape2::melt(nes[, c("retention_time")])))  
# 
# # dt$value <- log(dt$value)
# 
# dens <- density(dt[dt$variable == "Milstead", "value"])
# dens <- data.frame(x = dens$x, y = dens$y)
# 
# gg <- ggplot(data = dt, aes(x = value)) +
#   geom_density(aes(linetype = variable), alpha = 0.5, size = 1.55) + 
#   scale_x_log10(breaks = as.numeric(yr_labels)[c(3, 5, 7)], 
#                 labels = mixed_labels[c(3, 5, 7)]) + 
#   cowplot::theme_cowplot() + theme(legend.position = c(0.15, 0.8), legend.title = element_blank(), legend.text = element_text()) +
#   xlab("Residence Time") + 
#   geom_segment(data = data.frame(x = quants[c(2, 4)], y = c(0.266, 0.48)), 
#                aes(x = x, y = 0, xend = x, yend = y), size = 1.55)
# 
# if(!interactive()){  
#   ggsave("hrt_density.pdf", gg, height = 4)
# }
# 
# # nes_fit_single <- ggplot(data = nes, aes(x = retention_time, y = p_percent_retention)) +
# #   geom_point() +
# #   scale_x_log10(labels = mixed_labels[c(2:4)], breaks = c(1e-05, 1e-02, 1e+01)) +
# #   stat_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
# #   scale_color_brewer(palette = "Set1") +
#   cowplot::theme_cowplot() + 
#   theme(legend.position = "none", legend.title = element_blank(), legend.text = element_text()) +
#   xlab("Residence Time") +
#   ylab("P Retention (%)")
```

```{r p-retention_vs_percent-ag, fig.cap="P retention versus percent agriculture in network watersheds.", fig.width = 3, fig.height = 3}
nes_nws$percent_ag <- nes_iws$iws_nlcd1992_pct_81 + nes_iws$iws_nlcd1992_pct_82

ggplot() + 
  geom_point(data = nes_nws, aes(x = percent_ag, y = p_percent_retention)) +
  xlab("Percent Agriculture") + ylab("P Retention")

```

```{r nes_vs_nla, fig.cap="Comparison of selected lake characteristics among the stratified random sampling design of the National Lakes Assessment (nla) and the haphazard sampling of the National Eutrophication Survey (nes) lakes analyzed in the present study.", fig.height=4}
# , message=FALSE, warning=FALSE
nla <- nla_load(2012)

tp <- select(nla$waterchem_wide, PTL_RESULT, UID) %>%
      left_join(select(nla$wide_siteinfo, AREA_HA, SITE_ID, UID)) %>%
      group_by(SITE_ID) %>%
      summarize(tp = median(PTL_RESULT), area = median(AREA_HA) / 100)

chl  <- select(nla$chla_wide, CHLX_RESULT, UID)  %>%
        left_join(select(nla$wide_siteinfo, SITE_ID, UID)) %>%
        group_by(SITE_ID) %>%
        summarize(chl = median(CHLX_RESULT))

secchi  <- select(nla$secchi, SECCHI, SITE_ID)  %>%
           group_by(SITE_ID) %>%
           summarize(secchi = median(SECCHI))

depth <- select(nla$wide_phab, DEPTH_AT_STATION, SITE_ID)  %>%
           group_by(SITE_ID) %>%
           summarize(depth = median(DEPTH_AT_STATION))

nla <- reduce(list(tp, chl, secchi, depth), left_join)
# skimr::skim(res)
nla <- gather(select(nla, -SITE_ID), variable, value)
nla$id <- "nla"

nes <- select(nes_iws, tp, area = surface_area, chl, secchi, depth = maxdepth)
nes$tp <- 1000 * nes$tp # mg to ug
nes <- gather(nes, variable, value)
nes$id <- "nes"

res <- rbind(nla, nes)

# ggplot(data = dplyr::filter(res, variable == "chl"), aes(y = id, x = value + 0.1)) + 
#   geom_density_ridges() + 
#   scale_x_log10()

ggplot(data = res, aes(y = id, x = value + 0.1)) + 
  geom_density_ridges() + 
  scale_x_log10() + 
  facet_wrap(~variable) + 
  theme(axis.title = element_blank())
```
